name: Market Analytics Pipeline (IST)

on:
  schedule:
    # Daily run at 8:00 PM IST (14:30 UTC)
    - cron: "30 14 * * *"

    # Monthly refresh (same time)
    - cron: "30 14 1 * *"

  workflow_dispatch:

jobs:
  run-market-analytics:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # Checkout source repo (eod2)
      # -----------------------------
      - name: Checkout EOD2 repo
        uses: actions/checkout@v4
        with:
          submodules: recursive      # ðŸ”‘ CRITICAL
          fetch-depth: 0

      # -----------------------------
      # Python setup
      # -----------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      # -----------------------------
      # UPDATE EOD DATA (CRITICAL)
      # -----------------------------
      - name: Update NSE EOD data
        run: |
          python -u src/init.py

      # -----------------------------
      # Run analytics pipeline
      # -----------------------------
      - name: Run market analytics
        run: |
          python -u src/breadth.py

      - name: Generate interactive HTML dashboard
        run: |
          python -u src/generate_dashboard_html.py

      # -----------------------------
      # Checkout MarketAnalytics repo
      # -----------------------------
      - name: Checkout MarketAnalytics repo
        uses: actions/checkout@v4
        with:
          repository: achyuthunipradyumna-sudo/MarketAnalytics
          path: MarketAnalytics
          token: ${{ secrets.MARKET_ANALYTICS_PAT }}

      # -----------------------------
      # Copy outputs (CSV + dashboards)
      # -----------------------------
      - name: Copy analytics outputs
        run: |
          set -e
      
          mkdir -p MarketAnalytics/data/daily
          mkdir -p MarketAnalytics/data/lookback
          mkdir -p MarketAnalytics/data/history
      
          # ---- DAILY CSV (latest) ----
          DAILY_FILE=$(ls -t src/output/breadth_????-??-??.csv | head -1 || true)
          if [ -n "$DAILY_FILE" ]; then
            cp "$DAILY_FILE" MarketAnalytics/data/daily/
          fi
      
          # ---- LOOKBACK ----
          if [ -f src/output/breadth_lookback_260.csv ]; then
            cp src/output/breadth_lookback_260.csv MarketAnalytics/data/lookback/
          fi
      
          # ---- FULL HISTORY ----
          if [ -f src/output/breadth_full_history.csv ]; then
            cp src/output/breadth_full_history.csv MarketAnalytics/data/history/
          fi

          # ---- HTML DASHBOARD ----
          if [ -f src/output/dashboard.html ]; then
            cp src/output/dashboard.html MarketAnalytics/
          fi
      # -----------------------------
      # Commit & push to MarketAnalytics
      # -----------------------------
      - name: Commit & push MarketAnalytics updates
        env:
          PAT: ${{ secrets.MARKET_ANALYTICS_PAT }}
        run: |
          cd MarketAnalytics

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # ðŸ”‘ Force PAT auth for push
          git remote set-url origin https://x-access-token:${PAT}@github.com/achyuthunipradyumna-sudo/MarketAnalytics.git

          if [[ -n "$(git status --porcelain)" ]]; then
            git add .
            git commit -m "Automated market analytics update"
            git push origin main
          else
            echo "[INFO] No changes to commit"
          fi
