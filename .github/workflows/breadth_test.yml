name: Market Breadth (IST)

on:
  schedule:
    # Daily at 8:00 PM IST (14:30 UTC)
    - cron: "30 14 * * *"

    # Monthly at 8:00 PM IST on 1st
    - cron: "30 14 1 * *"

  workflow_dispatch:

jobs:
  run-breadth:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout eod2 repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run breadth analysis
        run: |
          python -u src/breadth.py

      # -----------------------------
      # Checkout MarketAnalytics repo
      # -----------------------------
      - name: Checkout MarketAnalytics repo
        uses: actions/checkout@v4
        with:
          repository: achyuthunipradyumna-sudo/MarketAnalytics
          token: ${{ secrets.MARKET_ANALYTICS_PAT }}
          path: MarketAnalytics

      # -----------------------------
      # Copy outputs
      # -----------------------------
      - name: Copy breadth outputs
        run: |
          TODAY=$(date -u +"%Y-%m-%d")

          mkdir -p MarketAnalytics/daily
          mkdir -p MarketAnalytics/lookback
          mkdir -p MarketAnalytics/history

          cp output/breadth_${TODAY}.csv MarketAnalytics/daily/
          cp output/breadth_lookback_260.csv MarketAnalytics/lookback/
          cp output/breadth_full_history.csv MarketAnalytics/history/

      # -----------------------------
      # Commit & push
      # -----------------------------
      - name: Commit and push to MarketAnalytics
        run: |
          cd MarketAnalytics
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add .
          git commit -m "Update breadth data (${GITHUB_RUN_ID})" || echo "No changes"
          git push